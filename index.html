<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pilot Monitoring Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* subtle gradient line for timelines */
        .timeline-line { background: linear-gradient(90deg, rgba(99,102,241,0.15), rgba(96,165,250,0.15)); }
        .card-hover:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(16,24,40,0.08); }
        /* prevent horizontal scrollbar jump on small timelines */
        .timeline-scroll { -webkit-overflow-scrolling: touch; }
                        /* lightweight aqua/harbor theme variables */
                :root {
                    --harbor-50: #f0f9ff;
                    --harbor-100: #e0f2fe;
                    --harbor-200: #bae6fd;
                    --harbor-300: #7dd3fc;
                    --harbor-400: #38bdf8;
                    --harbor-500: #0ea5e9;
                    --harbor-accent: #60a5fa;
                    --harbor-rose: #fb7185;
                    --harbor-amber: #f59e0b;
                }
                .harbor-bg { background: var(--harbor-50); }
                .harbor-accent { background: linear-gradient(180deg, var(--harbor-400), var(--harbor-300)); }
                .harbor-text { color: var(--harbor-500); }
                        /* Pleasant page background and cards */
                        body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
                        .page-gradient { background: linear-gradient(180deg, #f7fbff 0%, #eef9ff 50%, #f7fbff 100%); }
                        .decor-wave { position: absolute; left: 0; right: 0; height: 140px; top: 0; pointer-events: none; opacity: 0.9; }
                        .card-soft { background: rgba(255,255,255,0.9); box-shadow: 0 8px 24px rgba(13, 38, 59, 0.06); border: 1px solid rgba(15, 23, 42, 0.03); }
                        .stat-value { letter-spacing: -0.02em; }
                    /* decorative bubbles */
                    .bubble { position: absolute; border-radius: 9999px; opacity: 0.12; filter: blur(12px); transform: translateZ(0); }
                    .bubble--one { width: 220px; height: 220px; left: -40px; top: 60px; background: var(--harbor-accent); }
                    .bubble--two { width: 140px; height: 140px; right: -20px; top: 180px; background: #cfeefd; }
                    .badge-header { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 999px; background: linear-gradient(90deg,#e6f7ff,#dbeefe); color: #0369a1; font-weight:600; }
                    .glass { backdrop-filter: blur(6px); }
                    .stat-icon { background: linear-gradient(135deg,var(--harbor-400),var(--harbor-300)); -webkit-background-clip: text; background-clip: text; color: transparent; }
                    .card-entrance { transform: translateY(8px); opacity: 0; animation: entrance 420ms cubic-bezier(.2,.9,.2,1) forwards; }
                    @keyframes entrance { to { transform: none; opacity: 1; } }
                /* ship silhouette */
                .ship-silhouette { position: absolute; left: 4%; bottom: 4%; width: 520px; height: auto; opacity: 0.06; filter: blur(6px) saturate(0.9); pointer-events: none; transform: translateZ(0); }
        /* delay styles */
        .delay-card { background: linear-gradient(180deg, rgba(251,113,133,0.06), rgba(255,245,247,0.03)); border: 1px solid rgba(251,113,133,0.18); }
        .delay-badge { background: var(--harbor-rose); color: white; border: none; }
        /* warning styles for upcoming pilot requests */
        .warning-card { background: linear-gradient(180deg, rgba(245,158,11,0.06), rgba(255,251,235,0.03)); border: 1px solid rgba(245,158,11,0.18); }
        .warning-badge { background: var(--harbor-amber); color: white; border: none; }
        /* Filters layout helpers to avoid overlap and keep proportions */
        .filters-grid { display: grid; grid-template-columns: 1fr; gap: 0.75rem; align-items: center; }
        @media (min-width: 768px) {
            /* On tablet+ show six columns: total data, branch, company, status, search, clear */
            .filters-grid { grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto; }
        }
        .filter-control { position: relative; }
        .filter-select, .filter-input { width: 100%; padding: 0.75rem 2.5rem 0.75rem 0.9rem; border-radius: 0.5rem; border: 1px solid #e6edf3; box-shadow: none; background: #ffffff; font-size: 0.875rem; }
        .filter-select:focus, .filter-input:focus { outline: none; box-shadow: 0 0 0 4px rgba(99,102,241,0.06); border-color: rgba(99,102,241,0.3); }
        .filter-control .chev { position: absolute; right: 0.65rem; top: 50%; transform: translateY(-50%); pointer-events: none; color: #94a3b8; }
        /* Ensure the search input icon is left-aligned without overlapping text */
        .filter-input-wrapper { position: relative; }
        .filter-input-wrapper .search-icon { position: absolute; left: 0.65rem; top: 50%; transform: translateY(-50%); color: #94a3b8; pointer-events: none; }
        .filter-input { padding-left: 2.6rem; }
        .dropdown-option { padding: 0.5rem 0.75rem; cursor: pointer; transition: background-color 0.15s; }
        .dropdown-option:hover { background-color: #f3f4f6; }
        .chev { position: absolute; right: 0.65rem; top: 50%; transform: translateY(-50%); pointer-events: none; color: #94a3b8; transition: transform 0.2s; }
        .filter-control .chev.rotate { transform: translateY(-50%) rotate(180deg); }
    </style>
</head>
<body class="harbor-bg min-h-screen page-gradient relative overflow-x-hidden">
        <svg class="decor-wave" viewBox="0 0 1440 320" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
            <path fill="#e6f7ff" d="M0,64L48,80C96,96,192,128,288,165.3C384,203,480,245,576,234.7C672,224,768,160,864,141.3C960,123,1056,149,1152,176C1248,203,1344,229,1392,242.7L1440,256L1440,0L1392,0C1344,0,1248,0,1152,0C1056,0,960,0,864,0C768,0,672,0,576,0C480,0,384,0,288,0C192,0,96,0,48,0L0,0Z"></path>
        </svg>
        <div class="container mx-auto px-4 py-12 max-w-7xl relative">
        <!-- Header -->
        <div class="text-center mb-8 relative">
            <div class="bubble bubble--one"></div>
            <div class="bubble bubble--two"></div>
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-2">
                Pilot Monitoring Dashboard
            </h1>
            <p class="text-md md:text-lg text-gray-600 max-w-3xl mx-auto">
                Real-time monitoring of pilot activities
            </p>
            <div class="mt-6 grid grid-cols-2 gap-4 justify-center max-w-lg mx-auto">
                <button id="boardButton" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    BOARD
                </button>
                <button id="pertaminaButton" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 text-white font-semibold rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    BOARD PERTAMINA
                </button>
                <button id="banjarmasinButton" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white font-semibold rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    BOARD BANJARMASIN
                </button>
                <button id="perakButton" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-semibold rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 text-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    BOARD PERAK
                </button>
            </div>
        </div>

        <!-- Stats Cards (harbor themed) -->
    <div class="grid grid-cols-1 gap-3 mb-6 mt-4 hidden">
            <!-- Card 2: Total Kapal Delay -->
            <div class="relative rounded-lg p-1 ring-0 card-hover overflow-hidden glass card-entrance hidden">
                <div class="absolute left-0 top-0 bottom-0 w-1 rounded-tr-lg rounded-br-lg" style="background:linear-gradient(180deg,var(--harbor-rose),#fecaca)"></div>
                <div class="flex items-center gap-1 ml-1">
                        <div class="flex-shrink-0 p-0.5 rounded-full" style="background:#fff1f2">
                        <svg class="w-2.5 h-2.5" style="color:var(--harbor-rose)" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v4m0 4h.01"/></svg>
                    </div>
                    <div>
                        <p class="text-[10px] text-gray-500">Total Kapal Delay</p>
                        <p id="totalDelayTop" class="text-sm md:text-base lg:text-lg font-extrabold text-rose-600">0</p>
                    </div>
                </div>
            </div>

            <!-- Card 3: Upcoming Pilot Requests <30min -->
            <div class="relative rounded-lg p-1 ring-0 card-hover overflow-hidden glass card-entrance hidden">
                <div class="absolute left-0 top-0 bottom-0 w-1 rounded-tr-lg rounded-br-lg" style="background:linear-gradient(180deg,var(--harbor-amber),#fef3c7)"></div>
                <div class="flex items-center gap-1 ml-1">
                        <div class="flex-shrink-0 p-0.5 rounded-full" style="background:#fffbeb">
                        <svg class="w-2.5 h-2.5" style="color:var(--harbor-amber)" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3"/></svg>
                    </div>
                    <div>
                        <p class="text-[10px] text-gray-500">Pilot Request &lt; 30min</p>
                        <p id="totalWarningTop" class="text-sm md:text-base lg:text-lg font-extrabold text-amber-600">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
    <div class="card-soft rounded-xl">
            <!-- Filters Header -->
            <div class="px-6 py-4 border-b border-gray-100" style="background: linear-gradient(135deg, var(--harbor-50), var(--harbor-100));">
                <div class="text-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Pilot Activity Timelines</h2>
                </div>
                <div class="flex justify-center">
                    <div class="filters-grid w-full max-w-4xl">
                        <div class="filter-control">
                            <div class="relative rounded-lg p-1 ring-0 card-hover overflow-hidden glass card-entrance" style="min-width: 120px;">
                                <div class="absolute left-0 top-0 bottom-0 w-1 rounded-tr-lg rounded-br-lg harbor-accent"></div>
                                <div class="flex items-center gap-1 ml-1">
                                    <div class="flex-shrink-0 p-0.5 rounded-full" style="background:var(--harbor-50)">
                                        <svg class="w-2.5 h-2.5 harbor-text" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 3v18h18"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 13l4-4 4 4 6-6"/></svg>
                                    </div>
                                    <div>
                                        <p class="text-[10px] text-gray-500">Total Data</p>
                                        <p id="totalDataTop" class="text-sm md:text-base lg:text-lg font-extrabold text-gray-900">0</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="filter-control">
                            <label for="branchSelect" class="sr-only">Branch</label>
                            <div class="relative">
                                <input type="text" id="branchSelect" placeholder="Search Branches..." class="filter-input pr-10" autocomplete="off">
                                <div class="chev">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                                <div id="branchDropdown" class="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-auto hidden">
                                    <!-- Options will be populated here -->
                                </div>
                            </div>
                        </div>

                        <div class="filter-control">
                            <label for="companySelect" class="sr-only">Company</label>
                            <div class="relative">
                                <input type="text" id="companySelect" placeholder="Search Companies..." class="filter-input pr-10" autocomplete="off">
                                <div class="chev">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                                <div id="companyDropdown" class="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-auto hidden">
                                    <!-- Options will be populated here -->
                                </div>
                            </div>
                        </div>

                        <div class="filter-control">
                            <label for="statusSelect" class="sr-only">Status</label>
                            <div class="relative">
                                <input type="text" id="statusSelect" placeholder="Filter by Status..." class="filter-input pr-10" autocomplete="off">
                                <div class="chev">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                                <div id="statusDropdown" class="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-auto hidden">
                                    <!-- Options will be populated here -->
                                </div>
                            </div>
                        </div>

                        <div class="filter-input-wrapper">
                            <label for="vesselSearch" class="sr-only">Search Vessel</label>
                            <div class="filter-input-wrapper relative">
                                <svg class="search-icon w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                <input type="text" id="vesselSearch" placeholder="Search Vessel..." class="filter-input" />
                            </div>
                        </div>

                        <div class="flex items-center">
                            <button id="clearFilters" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white text-sm font-medium rounded-md transition-colors duration-200">
                                Clear Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timeline Container -->
            <div id="timelineContainer" class="p-6 space-y-6">
                <!-- Cards will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Load CSV data
        fetch('job.csv')
            .then(response => response.text())
            .then(csvText => {
                Papa.parse(csvText, {
                    header: true,
                    complete: function(results) {
                        const data = results.data;
                        document.getElementById('totalDataTop').textContent = `Total Data: ${data.length}`;
                        let delayCount = 0;
                        let shortApproachCount = 0;
                        let warningCount = 0;
                        const container = document.getElementById('timelineContainer');
                        const branchInput = document.getElementById('branchSelect');
                        const companyInput = document.getElementById('companySelect');
                        const statusInput = document.getElementById('statusSelect');
                        const branchDropdown = document.getElementById('branchDropdown');
                        const companyDropdown = document.getElementById('companyDropdown');
                        const statusDropdown = document.getElementById('statusDropdown');
                        const branches = new Set();
                        const companies = new Set();
                        const branchCounts = {};
                        const companyCounts = {};
                        
                        data.forEach(row => {
                            if (row.name_branch) {
                                const branch = row.name_branch.trim();
                                branches.add(branch);
                                branchCounts[branch] = (branchCounts[branch] || 0) + 1;
                            }
                            if (row.company_name) {
                                const company = row.company_name.trim();
                                companies.add(company);
                                companyCounts[company] = (companyCounts[company] || 0) + 1;
                            }
                        });
                        
                        // Store data for filtering
                        const branchData = Array.from(branches).sort();
                        const companyData = Array.from(companies).sort();
                        const statusData = ['DELAY', 'MENDEKATI PELAYANAN', 'NORMAL'];
                        const statusCounts = { 'DELAY': 0, 'MENDEKATI PELAYANAN': 0, 'NORMAL': 0 };
                        
                        const now = new Date();
                        
                        // Count statuses
                        data.forEach(row => {
                            const reqTime = row.request_time ? new Date(row.request_time) : null;
                            const deployTime = row.pilot_deploy ? new Date(row.pilot_deploy) : null;
                            let status = 'NORMAL';
                            if (reqTime) {
                                if (reqTime < now && !deployTime) {
                                    status = 'DELAY';
                                } else if (reqTime > now && (reqTime - now) <= 30 * 60 * 1000) {
                                    status = 'MENDEKATI PELAYANAN';
                                }
                            }
                            statusCounts[status]++;
                        });
                        
                        // Function to render dropdown options
                        function renderDropdown(dropdown, data, counts, searchTerm = '') {
                            dropdown.innerHTML = '';
                            const filteredData = data.filter(item => 
                                item.toLowerCase().includes(searchTerm.toLowerCase())
                            );
                            
                            // Add "All" option first (only if no search term or if "all" matches)
                            if (!searchTerm || 'all'.includes(searchTerm.toLowerCase())) {
                                const allOption = document.createElement('div');
                                allOption.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm font-medium';
                                allOption.textContent = `All (${data.length})`;
                                allOption.dataset.value = 'all';
                                dropdown.appendChild(allOption);
                            }
                            
                            // Add filtered options
                            filteredData.forEach(item => {
                                const option = document.createElement('div');
                                option.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm';
                                option.textContent = `${item} (${counts[item]})`;
                                option.dataset.value = item;
                                dropdown.appendChild(option);
                            });
                            
                            // Show "No results" if no matches
                            if (filteredData.length === 0 && searchTerm && !'all'.includes(searchTerm.toLowerCase())) {
                                const noResult = document.createElement('div');
                                noResult.className = 'px-3 py-2 text-sm text-gray-500';
                                noResult.textContent = 'No results found';
                                dropdown.appendChild(noResult);
                            }
                        }
                        
                        // Initialize dropdowns
                        renderDropdown(branchDropdown, branchData, branchCounts);
                        renderDropdown(companyDropdown, companyData, companyCounts);
                        renderDropdown(statusDropdown, statusData, statusCounts);
                        
                        // Handle input focus
                        branchInput.addEventListener('focus', () => {
                            const currentValue = branchInput.dataset.value;
                            if (currentValue === 'all') {
                                branchInput.value = '';
                            }
                            renderDropdown(branchDropdown, branchData, branchCounts, branchInput.value);
                            branchDropdown.classList.remove('hidden');
                            branchInput.nextElementSibling.classList.add('rotate');
                            companyDropdown.classList.add('hidden');
                            companyInput.nextElementSibling.classList.remove('rotate');
                            statusDropdown.classList.add('hidden');
                            statusInput.nextElementSibling.classList.remove('rotate');
                        });
                        
                        companyInput.addEventListener('focus', () => {
                            const currentValue = companyInput.dataset.value;
                            if (currentValue === 'all') {
                                companyInput.value = '';
                            }
                            renderDropdown(companyDropdown, companyData, companyCounts, companyInput.value);
                            companyDropdown.classList.remove('hidden');
                            companyInput.nextElementSibling.classList.add('rotate');
                            branchDropdown.classList.add('hidden');
                            branchInput.nextElementSibling.classList.remove('rotate');
                            statusDropdown.classList.add('hidden');
                            statusInput.nextElementSibling.classList.remove('rotate');
                        });
                        
                        statusInput.addEventListener('focus', () => {
                            const currentValue = statusInput.dataset.value;
                            if (currentValue === 'all') {
                                statusInput.value = '';
                            }
                            renderDropdown(statusDropdown, statusData, statusCounts, statusInput.value);
                            statusDropdown.classList.remove('hidden');
                            statusInput.nextElementSibling.classList.add('rotate');
                            branchDropdown.classList.add('hidden');
                            branchInput.nextElementSibling.classList.remove('rotate');
                            companyDropdown.classList.add('hidden');
                            companyInput.nextElementSibling.classList.remove('rotate');
                        });
                        
                        // Handle input changes
                        branchInput.addEventListener('input', (e) => {
                            renderDropdown(branchDropdown, branchData, branchCounts, e.target.value);
                            branchDropdown.classList.remove('hidden');
                            branchInput.nextElementSibling.classList.add('rotate');
                        });
                        
                        companyInput.addEventListener('input', (e) => {
                            renderDropdown(companyDropdown, companyData, companyCounts, e.target.value);
                            companyDropdown.classList.remove('hidden');
                            companyInput.nextElementSibling.classList.add('rotate');
                        });
                        
                        statusInput.addEventListener('input', (e) => {
                            renderDropdown(statusDropdown, statusData, statusCounts, e.target.value);
                            statusDropdown.classList.remove('hidden');
                            statusInput.nextElementSibling.classList.add('rotate');
                        });
                        
                        // Handle dropdown selection
                        branchDropdown.addEventListener('click', (e) => {
                            if (e.target.dataset.value) {
                                const selectedValue = e.target.dataset.value;
                                branchInput.dataset.value = selectedValue;
                                if (selectedValue === 'all') {
                                    branchInput.value = `All Branches (${branchData.length})`;
                                } else {
                                    branchInput.value = e.target.textContent;
                                }
                                branchDropdown.classList.add('hidden');
                                branchInput.nextElementSibling.classList.remove('rotate');
                                filterCards();
                            }
                        });
                        
                        companyDropdown.addEventListener('click', (e) => {
                            if (e.target.dataset.value) {
                                const selectedValue = e.target.dataset.value;
                                companyInput.dataset.value = selectedValue;
                                if (selectedValue === 'all') {
                                    companyInput.value = `All Companies (${companyData.length})`;
                                } else {
                                    companyInput.value = e.target.textContent;
                                }
                                companyDropdown.classList.add('hidden');
                                companyInput.nextElementSibling.classList.remove('rotate');
                                filterCards();
                            }
                        });
                        
                        statusDropdown.addEventListener('click', (e) => {
                            if (e.target.dataset.value) {
                                const selectedValue = e.target.dataset.value;
                                statusInput.dataset.value = selectedValue;
                                if (selectedValue === 'all') {
                                    statusInput.value = `All Statuses (${statusData.length})`;
                                } else {
                                    statusInput.value = e.target.textContent;
                                }
                                statusDropdown.classList.add('hidden');
                                statusInput.nextElementSibling.classList.remove('rotate');
                                filterCards();
                            }
                        });
                        
                        // Close dropdowns when clicking outside
                        document.addEventListener('click', (e) => {
                            if (!e.target.closest('.filter-control')) {
                                branchDropdown.classList.add('hidden');
                                companyDropdown.classList.add('hidden');
                                statusDropdown.classList.add('hidden');
                                branchInput.nextElementSibling.classList.remove('rotate');
                                companyInput.nextElementSibling.classList.remove('rotate');
                                statusInput.nextElementSibling.classList.remove('rotate');
                            }
                        });
                        
                        data.forEach(row => {
                            const card = document.createElement('div');
                            card.className = 'bg-white rounded-xl shadow-md card-hover p-6 border border-gray-200 transition-all duration-300';
                            card.setAttribute('data-branch', (row.name_branch || '').trim());
                            card.setAttribute('data-company', (row.company_name || '').trim());
                            card.setAttribute('data-vessel', row.vessel_name || '');
                            
                            const header = document.createElement('h3');
                            header.className = 'text-lg font-semibold text-gray-800 mb-3 flex items-center justify-between';
                            header.innerHTML = `
                                <span class="text-sm md:text-base text-gray-600">${row.vessel_name || 'N/A'}</span>
                                <span class="flex items-center text-sm gap-3">
                                    <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                                    </svg>
                                    <span class="text-xs text-gray-500">Order No: ${row.order_no || 'N/A'}</span>
                                    <span class="font-mono text-xs text-gray-700">ID: ${row.id_order_header || 'N/A'}</span>
                                </span>
                            `;
                            card.appendChild(header);
                            
                            const branchDiv = document.createElement('div');
                            branchDiv.className = 'text-xs text-gray-500';
                            branchDiv.textContent = row.name_branch || 'N/A';
                            card.appendChild(branchDiv);
                            
                            const details = document.createElement('div');
                            details.className = 'grid grid-cols-1 md:grid-cols-2 gap-3 mb-4 text-xs md:text-sm bg-gray-50 p-3 rounded-lg border';
                            
                            const companyName = document.createElement('div');
                            companyName.innerHTML = `<strong class="text-indigo-700">Company:</strong> ${row.company_name || 'N/A'}`;
                            details.appendChild(companyName);
                            
                            const requestTime = document.createElement('div');
                            requestTime.innerHTML = `<strong class="text-indigo-700">Pilot Request Time:</strong> ${row.request_time ? new Date(row.request_time).toLocaleString('id-ID', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : 'N/A'}`;
                            details.appendChild(requestTime);
                            
                            const pilotName = document.createElement('div');
                            pilotName.innerHTML = `<strong class="text-indigo-700">Pilot Name:</strong> ${row.full_name || 'N/A'}`;
                            details.appendChild(pilotName);
                            
                            const locationName = document.createElement('div');
                            locationName.innerHTML = `<strong class="text-indigo-700">Location:</strong> ${row.location_name || 'N/A'}`;
                            details.appendChild(locationName);
                            
                            const noPkk = document.createElement('div');
                            noPkk.innerHTML = `<strong class="text-indigo-700">No PKK Inaportnet:</strong> ${row.no_pkk_inaportnet || 'N/A'}`;
                            details.appendChild(noPkk);
                            
                            card.appendChild(details);
                            
                            const timeline = document.createElement('div');
                            timeline.className = 'relative flex items-center space-x-4 overflow-x-auto bg-gradient-to-r from-indigo-50 to-blue-50 p-4 rounded-lg';
                            
                            // Add connecting line
                            const line = document.createElement('div');
                            line.className = 'absolute top-8 left-8 right-8 h-0.5 timeline-line z-0';
                            timeline.appendChild(line);
                            
                            const steps = [
                                { label: 'Pilot Deploy', time: row.pilot_deploy },
                                { label: 'Pilot Arrive', time: row.pilot_arrive },
                                { label: 'Pilot Onboard', time: row.pilot_onboard },
                                { label: 'Pilot Start', time: row.pilot_start },
                                { label: 'Pilot End', time: row.pilot_end },
                                { label: 'Pilot Off', time: row.pilot_off }
                            ];
                            
                            // Check if Pilot Start to Pilot End duration < 30 minutes
                            const pilotStartTime = row.pilot_start ? new Date(row.pilot_start) : null;
                            const pilotEndTime = row.pilot_end ? new Date(row.pilot_end) : null;
                            const isShortDuration = pilotStartTime && pilotEndTime && (pilotEndTime - pilotStartTime) < 10 * 60 * 1000;
                            if (isShortDuration) shortApproachCount++;
                            
                            steps.forEach((step, index) => {
                                const stepDiv = document.createElement('div');
                                stepDiv.className = 'flex flex-col items-center min-w-0 z-10';
                                
                                const icon = document.createElement('div');
                                const isCompleted = step.time ? true : false;
                                let bgColor = 'bg-gray-400';
                                if (isCompleted) {
                                    if ((step.label === 'Pilot Start' || step.label === 'Pilot End') && isShortDuration) {
                                        bgColor = 'bg-red-500';
                                    } else {
                                        bgColor = 'bg-blue-500';
                                    }
                                }
                                icon.className = `w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-bold shadow-md ${bgColor}`;
                                icon.innerHTML = step.time ? `
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                ` : `${index + 1}`;
                                stepDiv.appendChild(icon);
                                
                                const label = document.createElement('div');
                                label.className = 'text-[11px] text-gray-700 mt-2 text-center font-medium';
                                label.textContent = step.label;
                                stepDiv.appendChild(label);
                                
                                const time = document.createElement('div');
                                time.className = 'text-[11px] text-gray-600 mt-1 text-center bg-white px-2 py-1 rounded shadow-sm';
                                if (step.time) {
                                    const date = new Date(step.time);
                                    time.textContent = date.toLocaleString('id-ID', { 
                                        year: 'numeric', 
                                        month: '2-digit', 
                                        day: '2-digit', 
                                        hour: '2-digit', 
                                        minute: '2-digit' 
                                    });
                                } else {
                                    time.textContent = 'Proses';
                                }
                                stepDiv.appendChild(time);
                                
                                timeline.appendChild(stepDiv);
                                
                                if (index < steps.length - 1) {
                                    const spacer = document.createElement('div');
                                    spacer.className = 'w-8';
                                    timeline.appendChild(spacer);
                                }
                            });
                            
                            card.appendChild(timeline);
                            
                            // Cek jika delay
                            const now = new Date();
                            const reqTime = row.request_time ? new Date(row.request_time) : null;
                            const deployTime = row.pilot_deploy ? new Date(row.pilot_deploy) : null;
                            
                            // Calculate status
                            let status = 'NORMAL';
                            if (reqTime) {
                                if (reqTime < now && !deployTime) {
                                    status = 'DELAY';
                                } else if (reqTime > now && (reqTime - now) <= 30 * 60 * 1000) {
                                    status = 'MENDEKATI PELAYANAN';
                                }
                            }
                            
                            card.setAttribute('data-status', status);
                            
                            // Check if within 30 minutes before pilot request time
                            if (reqTime && reqTime > now && (reqTime - now) <= 30 * 60 * 1000) {
                                card.classList.add('warning-card');
                                const warningDiv = document.createElement('div');
                                warningDiv.className = 'mt-4 p-3 rounded-lg text-center font-semibold warning-badge';
                                warningDiv.textContent = 'âš ï¸ PILOT REQUEST IN < 30 MIN';
                                card.appendChild(warningDiv);
                                warningCount++;
                            }
                            
                            if (reqTime && reqTime < now && !deployTime) {
                                // mark card visually as delayed using harbor delay styles
                                card.classList.add('delay-card');
                                const delayDiv = document.createElement('div');
                                delayDiv.className = 'mt-4 p-3 rounded-lg text-center font-semibold delay-badge';
                                delayDiv.textContent = 'ðŸš¨ DELAY DETECTED';
                                card.appendChild(delayDiv);
                                delayCount++;
                            }
                            
                            container.appendChild(card);
                        });
                        
                        document.getElementById('totalDelayTop').textContent = `Total Kapal Delay: ${delayCount}`;
                        document.getElementById('totalWarningTop').textContent = `Pilot Request < 30min: ${warningCount}`;
                        
                        // Filter function
                        function filterCards() {
                            const selectedBranch = document.getElementById('branchSelect').dataset.value || 'all';
                            const selectedCompany = document.getElementById('companySelect').dataset.value || 'all';
                            const selectedStatus = document.getElementById('statusSelect').dataset.value || 'all';
                            const searchTerm = document.getElementById('vesselSearch').value.toLowerCase();
                            const cards = container.querySelectorAll('[data-branch]');
                            cards.forEach(card => {
                                const branch = card.getAttribute('data-branch');
                                const company = card.getAttribute('data-company');
                                const status = card.getAttribute('data-status');
                                const vessel = card.getAttribute('data-vessel').toLowerCase();
                                const branchMatch = selectedBranch === 'all' || branch === selectedBranch;
                                const companyMatch = selectedCompany === 'all' || company === selectedCompany;
                                const statusMatch = selectedStatus === 'all' || status === selectedStatus;
                                const vesselMatch = !searchTerm || vessel.includes(searchTerm);
                                if (branchMatch && companyMatch && statusMatch && vesselMatch) {
                                    card.style.display = 'block';
                                } else {
                                    card.style.display = 'none';
                                }
                            });
                        }
                        
                        // Initial filter (show all)
                        document.getElementById('branchSelect').dataset.value = 'all';
                        document.getElementById('companySelect').dataset.value = 'all';
                        document.getElementById('statusSelect').dataset.value = 'all';
                        document.getElementById('branchSelect').value = `All Branches (${branchData.length})`;
                        document.getElementById('companySelect').value = `All Companies (${companyData.length})`;
                        document.getElementById('statusSelect').value = `All Statuses (${statusData.length})`;
                        
                        document.getElementById('vesselSearch').addEventListener('input', filterCards);
                        
                        // Clear filters button
                        document.getElementById('clearFilters').addEventListener('click', () => {
                            document.getElementById('branchSelect').dataset.value = 'all';
                            document.getElementById('companySelect').dataset.value = 'all';
                            document.getElementById('statusSelect').dataset.value = 'all';
                            document.getElementById('branchSelect').value = `All Branches (${branchData.length})`;
                            document.getElementById('companySelect').value = `All Companies (${companyData.length})`;
                            document.getElementById('statusSelect').value = `All Statuses (${statusData.length})`;
                            document.getElementById('vesselSearch').value = '';
                            filterCards();
                        });
                    }
                });
            })
            .catch(error => {
                console.error('Error loading CSV:', error);
                document.getElementById('timelineContainer').innerHTML = '<p class="text-center text-gray-500">Error loading data</p>';
            });

        // BOARD button functionality
        document.getElementById('boardButton').addEventListener('click', function() {
            window.location.href = 'informasi.html';
        });

        // BOARD PERTAMINA button functionality
        document.getElementById('pertaminaButton').addEventListener('click', function() {
            window.location.href = 'pertamina.html';
        });

        // BOARD BANJARMASIN button functionality
        document.getElementById('banjarmasinButton').addEventListener('click', function() {
            window.location.href = 'banjarmasin.html';
        });

        // BOARD PERAK button functionality
        document.getElementById('perakButton').addEventListener('click', function() {
            window.location.href = 'perak.html';
        });
    </script>
        <!-- subtle ship silhouette for background ambiance -->
        <svg class="ship-silhouette" viewBox="0 0 800 200" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <g fill="#083344">
                <path d="M10 120 C80 80, 220 60, 320 80 C420 100, 540 110, 760 90 L740 130 L60 130 Z"/>
                <path d="M160 70 L200 40 L250 60 L220 80 Z"/>
                <rect x="340" y="40" width="16" height="48" />
            </g>
        </svg>
</body>
</html>
